version: 2

key: &src-cache-key src-{{ .Branch }}-{{ .Revision }}
key: &npm-dependencies-cache-key npm-dependencies-{{ checksum "package.json" }}
key: &npm-prod-cache-key prod-{{ .Branch }}-{{ .Revision }}

jobs:
  install_dependencies:
    docker:
      - image: circleci/node:9.2.1
    working_directory: /home/circleci/project
    steps:
      - checkout
      - save_cache:
          paths:
            - ./
          key: *src-cache-key
      - run:
          name: Install npm dependencies
          command: |
            npm install
      - save_cache:
          paths:
            - node_modules
          key: npm-dependencies-{{ checksum "package.json" }}
  build_and_deploy_prod:
    docker:
      - image: circleci/node:9.2.1
    working_directory: /home/circleci/project
    steps:
      - restore_cache:
          key: *src-cache-key
      - restore_cache:
          key: *npm-dependencies-cache-key
      - run:
          name: Build package
          command: |
            node ./scripts/version.js
            PROD_CONFIG="export const environment={production:true,google:{maps:{apiKey:'$MAPS_API_KEY',libraries:['places']},places:{apiKey:'$PLACES_API_KEY'}},firebase:{apiKey:'$FIREBASE_API_KEY',authDomain:'$FIREBASE_AUTH_DOMAIN',databaseURL:'$FIREBASE_DB_URL',projectId:'$FIREBASE_PROJECT_ID',storageBucket:'$FIREBASE_STORAGE_BUCKET',messagingSenderId:'$FIREBASE_MESSAGING_SENDER_ID'}};"
            ECHO $PROD_CONFIG > src/environments/environment.prod.ts
            node ./node_modules/@angular/cli/bin/ng build --env=prod
      - run:
          name: "Publish to Firestore"
          command: |
            node node_modules/firebase-tools/bin/firebase deploy --token=$FIREBASE_TOKEN --non-interactive
      - save_cache:
          paths:
            - out
          key: *npm-prod-cache-key

workflows:
  version: 2
  build:
    jobs:
      - install_dependencies
      - build_and_deploy_prod:
          requires:
            - install_dependencies
          filters:
            branches:
              only:
                - develop